#!/bin/bash
#AUTHOR: Clout Phillip Tolstoy ...  clout [at] freegeek.org
#NOTES: one must have cdrecord working fully for this script, because 
#it is more, or less a wrapper for that util as well as md5sum
#REASON: this script is to automate the way we test cdrw drives so even less
#knowledge is need to do so ^_^
#TODO: Make it so this script uses two vars one for the ISO image, which it already does, and
#another one to override the for loop and just give it a /dev/real_device (/dev/hdc, /dev/sda1, etc...)
#example of future optional syntax: whateverthenameofthisscriptis /dev/hdc image.iso  

IMAGE=null

if [ ! -n "$1" ]; then
    echo "Usage: cdrwtester file.iso "
    echo "cdrwtester --readme"
elif [ "$1" = "--readme" ]; then
    less README.cdrwtester
    exit
fi
 
if [ -e "$1" ]; then
    IMAGE=$1
    export IMAGE
else
    echo "$1 is not a file!"
    exit
fi

DEVICE=null

for REPLY in $(cdrecord -scanbus 2>/dev/null \
    | egrep ' *[0-9]+,[0-9]+,[0-9]+' \
    | grep -v "*" \
    | awk '{print $1}'); do
  if DRIVES=$(cdrecord -checkdrive dev=$REPLY 2>/dev/null); then
        # :MC: will "Identifikation" always be after vender info? i hope so
      VENDOR=$(echo $DRIVES \
	  | sed "s/.*Vendor_info : '\(.*\)' I.*/\1/")
      if CDRW=$(echo $DRIVES \
	  | sed 's/.*Device seems to be:.*\(CD-RW\).*/\1/'); then
	  DEVICE=$REPLY
	  export DEVICE
      fi
      export CDRW
      export VENDOR
  fi
done
echo
echo this is a cdrw: $CDRW
echo this is the vendor:  $VENDOR
echo this is the dev value: $DEVICE
echo this is the ISO: $IMAGE
echo I will now burn the ISO
echo running command:
echo cdrecord dev=$DEVICE $IMAGE
echo press enter to do so
read
cdrecord dev=$DEVICE $IMAGE
if [ "$?" != 0 ]; then
    echo "cdrecord failed with an error: $?"               # probably add a fuction to find the real device
else                                                     # here and replace the one of the $IMAGE vars down 
    DEV=$(grep $VENDOR  /proc/ide/[a-z][a-z][a-z]/* 2> /dev/null)
    REALDEV=$(echo $DEV \
	| awk -F / '{print $4}')
fi                                                      # the info can be found in /proc/ide 
    

echo -e \\n  " I will now test the $IMAGE file, press enter"  ######## below with the real device var
read                                                  #
if [ ! -e $IMAGE.md5 ]; then  
    echo there is no $IMAGE.md5 file, I will now creat one
    md5sum $IMAGE > $IMAGE.md5
    diff <(md5sum /dev/$REALDEV) <(cat $IMAGE.md5)
    if [ "$?" = 0 ]; then
	echo "YAY the test passed"
    else
	echo "blaahh something is wrong"
    fi
else
    diff <(md5sum /dev/$REALDEV) <(cat $IMAGE.md5)
    if [ "$?" = 0 ]; then
	echo "passed md5 test"
    else
	echo "failed md5 test"
    fi
fi

#